<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Profile</title>
  <link rel="stylesheet" href="/stylesheets/profile.css" />
  <link rel="stylesheet" href="/stylesheets/loggedInNav.css" />
  <link rel="shortcut icon" href="/images/icons8-todo-list-16.png" type="image/x-icon" />

  <link rel="stylesheet" href="/stylesheets/trailingCursor.css" />

  <link rel="stylesheet" href="/stylesheets/footer.css" />
</head>

<body>
  <main id="root">
    <%- include("partials/logout") %>
    <div id="page-1">
      <section id="section-1">
        <nav class="nav-container">
          <div class="left-nav">
            <div id="user-desc">
              <div class="user-image">
                <img src="<%= user.profileImage %>" alt="user-image" />
              </div>
              <div class="user-name">
                <p><span><%= username %></span></p>
              </div>
            </div>
            <div class="upload-profile-image-btn">
              <input type="file" id="profile-image-input" accept="image/*" style="display: none" />
              <button id="change-profile-btn">Change Profile</button>
            </div>
          </div>

          <div class="right-nav">
            <div id="liveTasks" class="task-info">
              <p><span>Live Tasks</span></p>
              <p><span>0</span></p>
            </div>
            <div id="completedTasks" class="task-info">
              <p><span>Completed Tasks</span></p>
              <p><span>0</span></p>
            </div>
            <div id="totalTasks" class="task-info">
              <p><span>Total Tasks</span></p>
              <p><span>0</span></p>
            </div>
          </div>
        </nav>
      </section>

      <section id="section-2">
        <div class="tasks-category">
          <div id="liveTask" class="task-heading">
            <span>Live</span>
          </div>
          <div id="completedTask" class="task-heading">
            <span>Completed</span>
          </div>
          <div id="totalTask" class="task-heading selected">
            <span>Total</span>
          </div>
        </div>
        <div class="border-bottom"></div>
        <div class="tasks-container">
          <% tasks.forEach(task => { %>
          <div class="task-card">
            <div class="task-card-heading">
              <p><%= task.title %></p>
            </div>
            <div class="task-card-content">
              <ul class="task-list">
                <% task.content.forEach(ele => { %>
                <li class="task-item"><%= ele %></li>
                <% }) %>
              </ul>
            </div>
          </div>
          <% }) %>
        </div>
      </section>
    </div>
    <%- include('./partials/footer') %>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="/javascripts/profile.js"></script>
  <script src="/javascripts/trailingCursor.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const changeProfileBtn = document.getElementById("change-profile-btn");
      const profileImageInput = document.getElementById(
        "profile-image-input"
      );

      const username = "<%= username %>";

      // Show file input dialog when the button is clicked

      changeProfileBtn.addEventListener("click", () => {
        profileImageInput.click();
      });

      // Handle file upload
      profileImageInput.addEventListener("change", async (event) => {
        const file = event.target.files[0];
        if (!file) return alert("No file selected.");

        // Validate file type
        if (
          !["image/jpeg", "image/png", "image/gif", "image/jpg"].includes(
            file.type
          )
        ) {
          return alert(
            "Please upload a valid image file (JPEG, PNG, or GIF)."
          );
        }

        // Validate file size (e.g., max 2MB)
        const maxSize = 2 * 1024 * 1024 * 1024; // 2MB
        if (file.size > maxSize) {
          return alert(
            "File size exceeds 2GB. Please upload a smaller image."
          );
        }

        const formData = new FormData();
        formData.append("profileImage", file);

        try {
          const response = await fetch(
            `/users/${username}/uploadProfileImage`, {
              method: "POST",
              body: formData,
            }
          );

          const data = await response.json();
          if (response.ok) {
            alert("Profile image updated successfully!");
            location.reload(); // Reload to show the new image
          } else {
            alert(data.error || "Failed to upload profile image.");
          }
        } catch (error) {
          console.error("Error uploading profile image:", error);
          alert("An error occurred. Please try again.");
        }
      });
    });
  </script>
</body>

</html>